{% extends "admin/base_site.html" %}

{% block breadcrumbs %}
<div class="breadcrumbs">
  <a href="{% url 'admin:index' %}">Home</a>
  &rsaquo;
  <a href="/admin/user/">User</a>
  &rsaquo;
  Analytics
</div>
{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.bundle.min.js"></script>

<div style="width: 80%;">
  <canvas style="margin-bottom: 30px; width: 60%; height: 50%;" id="contributorsChart"></canvas>
</div>

<div>
  <label for="start_date">Start date:</label>
  <input type="date" id="start_date" name="start_date" value="2020-01-01">
  <label for="end_date">End date:</label>
  <input type="date" id="end_date" name="end_date" value="2020-01-01">
  <button id="reload">Reload chart data</button>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const ctx = document.getElementById('contributorsChart').getContext('2d');

    const chartData = {{ chart_data | safe }};

    // Parse the dates to JS
    chartData.forEach((d) => {
      d.x = new Date(d.date);
    });

    const contributorsChart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Unique Contributors',
            data: chartData,
            backgroundColor: 'rgba(220,20,20,0.5)',
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          xAxes: [
            {
              type: 'time',
              time: {
                unit: 'month',
                displayFormats: {
                  day: 'MM',
                },
              },
            },
          ],
          yAxes: [
            {
              ticks: {
                beginAtZero: true,
              },
            },
          ],
        },
      },
    });

    var date = new Date();
    date = date.toISOString().split('T')[0];
    document.getElementById('end_date').value = date;

    // Reload chart data from the backend on button click
    const reloadButton = document.getElementById('reload');

    reloadButton.addEventListener('click', async() => {
        var data = {
          start_date: document.getElementById('start_date').value,
          end_date: document.getElementById('end_date').value
        };
        var url = "/admin/user/analyticmodel/chart_data/";
        url += "?start_date=" + data.start_date;
        url += "&end_date=" + data.end_date;

        const res = await fetch(url);
        const json = await res.json();
        json.forEach((d) => {
          d.x = new Date(d.date);
        });
        contributorsChart.data.datasets[0].data = json;
        contributorsChart.update();
      }
    );
  });
</script>
{% endblock %}
